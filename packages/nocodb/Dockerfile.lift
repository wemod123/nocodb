FROM node:18.14.0-alpine as build

WORKDIR /app

COPY ./package*.json ./
COPY ./nc-lib-gui ./nc-lib-gui
COPY ./nocodb-sdk ./nocodb-sdk

RUN corepack enable && corepack prepare pnpm@latest --activate
RUN pnpm install --prod --shamefully-hoist --frozen-lockfile

COPY ./docker/main.js ./main.js
COPY ./src/public/ ./public

FROM node:18.14.0-alpine

WORKDIR /app
COPY --from=build /app .

ENV NODE_ENV production

EXPOSE 8080

CMD ["node", "main.js"]